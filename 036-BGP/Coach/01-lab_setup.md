# Challenge 1: Environment Setup - Coach's Guide

**[Home](./README.md)** - [Next Challenge >](./02-enable_bgp.md)

## Notes and Guidance

The script [bgp.sh](../Student/Resources/bgp.sh) can be used to create the basic topology. This script has been tested to run in the Azure Cloud shell, and takes around 1 hour to complete.

Participants have reportedly struggled with the scripts, sometimes because of not having enough privilege to accept the Cisco CSR Marketplace image, sometimes for other issues.

Hence it is recommended that the coach runs this script previous to the actual event, or at least one participant has tested it.

The resources can of course be created manually, but participants often get a "waste of time" feeling when investing a long time in creating Azure resources and configuring IPsec tunnels.

## Solution Guide

### Script Output Sample

Sample output of a deployment with [bgp.sh](../Student/Resources/bgp.sh):

<details>

<pre>
❯ ./bgp.sh "1:vng1:65001,2:vng:65002,3:csr:65100,4:csr:65100,5:csr:65100" "1:2:nobgp,1:3:nobgp,1:4:nobgp,2:3:nobgp,2:4:nobgp,3:4:nobgp,3:5,4:5" wthbgp northeurope "supersecretpsk"
All dependencies checked successfully
Azure CLI extension "log-analytics" found with version 0.2.1
Running on BASH
Press any key to start creating Azure resources into Azure subscription "Azure CXP FTA Internal Subscription JOMORE"...

Creating resource group wthbgp...
Accepting image terms for cisco:cisco-csr-1000v:16_12-byol:16.12.120190816...
Creating router of type vng1, id 1, ASN 65001...
Creating vnet vng1...
Creating test virtual machine testvm1 in vnet vng1 in new subnet 10.1.1.0/24...
Creating public IP addresses for gateway vng1...
Creating VNG vng1 in active/passive mode...
Creating router of type vng, id 2, ASN 65002...
Creating vnet vng2...
Creating test virtual machine testvm2 in vnet vng2 in new subnet 10.2.1.0/24...
Creating public IP addresses for gateway vng2...
Creating VNG vng2 in active/active mode...
Creating router of type csr, id 3, ASN 65100...
Creating VM csr3-nva in Vnet 10.3.0.0/16...
CSR created with IP address 52.138.173.126. Creating Local Network Gateway now...
Creating router of type csr, id 4, ASN 65100...
Creating VM csr4-nva in Vnet 10.4.0.0/16...
CSR created with IP address 40.69.71.195. Creating Local Network Gateway now...
Creating router of type csr, id 5, ASN 65100...
Creating VM csr5-nva in Vnet 10.5.0.0/16...
CSR created with IP address 52.164.228.44. Creating Local Network Gateway now...
Verifying 1:vng1:65001...
Gateway vng1 status is Updating
Verifying 2:vng:65002...
Gateway vng2 status is Updating
Verifying 3:csr:65100...
VM csr3-nva status is Creating, public IP is 52.138.173.126
Verifying 4:csr:65100...VM csr4-nva status is Creating, public IP is 40.69.71.195
Verifying 5:csr:65100...
VM csr5-nva status is Creating, public IP is 52.164.228.44
Waiting for CSR3 with IP address 52.138.173.126 to answer over SSH...
IP address 52.138.173.126 is available (wait time 3 minutes and 36 seconds). Answer to SSH command "show version | include uptime":
csr3-nva uptime is 0 minutes
Waiting for CSR4 with IP address 40.69.71.195 to answer over SSH...
IP address 40.69.71.195 is available (wait time 1 minutes and 4 seconds). Answer to SSH command "show version | include uptime":
csr4-nva uptime is 0 minutes
Waiting for CSR5 with IP address 52.164.228.44 to answer over SSH...
IP address 52.164.228.44 is available (wait time 1 minutes and 36 seconds). Answer to SSH command "show version | include uptime":
csr5-nva uptime is 1 minute
Our IP seems to be 109.125.122.99
Configuring CSR 52.138.173.126 for VPN and BGP...
Creating VM testvm3 in vnet csr3...
Enabling IP forwarding for csr3...
Our IP seems to be 109.125.122.99
Configuring CSR 40.69.71.195 for VPN and BGP...
Creating VM testvm4 in vnet csr4...
Enabling IP forwarding for csr4...
Our IP seems to be 109.125.122.99
Configuring CSR 52.164.228.44 for VPN and BGP...
Creating VM testvm5 in vnet csr5...
Enabling IP forwarding for csr5...
Adding RFC1918 prefixes to NSG csr3-nvaNSG...
Adding RFC1918 prefixes to NSG csr4-nvaNSG...
Adding RFC1918 prefixes to NSG csr5-nvaNSG...
Adding RFC1918 prefixes to NSG testvm1NSG...
Adding RFC1918 prefixes to NSG testvm2NSG...
Adding RFC1918 prefixes to NSG testvm3NSG...
Adding RFC1918 prefixes to NSG testvm4NSG...
Adding RFC1918 prefixes to NSG testvm5NSG...
Waiting for resource vng1 to finish provisioning...
Resource vng1 provisioning state is Succeeded, wait time 8 minutes and 14 seconds
Waiting for resource vng2 to finish provisioning...
Resource vng2 provisioning state is Succeeded, wait time 0 minutes and 1 seconds
Creating LA workspace log18471...
Configuring diagnostic settings for gateway vng1
Configuring diagnostic settings for gateway vng2
Creating connection between vng1 1 and vng 2, type "nobgp"...
Connecting vng1 and vng2. Finding out information about the gateways...
Extracted info for vpngw1: ASN 65001, 40.127.161.185, 10.1.0.254.
Creating local network gateways for vng1...
Creating local network gateways for vng2...
Extracted info for vpngw2: ASN 65002 GW0 40.127.161.56, 10.2.0.4. GW1 40.127.161.68, 10.2.0.5.
Connecting vng1 to local gateways for vng2...
Connecting vng2 to local gateways for vng1...
Creating connection between vng1 1 and csr 3, type "nobgp"...
Extracted info for vpngw: ASN 65001, 40.127.161.185, 10.1.0.254.
Configuring tunnels between CSR 3 and VPN GW 1
Configuring tunnel 310 in CSR 52.138.173.126...
No routing protocol configured on 310 in CSR 52.138.173.126...
Creating VPN connections in Azure...
Creating connection between vng1 1 and csr 4, type "nobgp"...
Extracted info for vpngw: ASN 65001, 40.127.161.185, 10.1.0.254.
Configuring tunnels between CSR 4 and VPN GW 1
Configuring tunnel 410 in CSR 40.69.71.195...
No routing protocol configured on 410 in CSR 40.69.71.195...
Creating VPN connections in Azure...
Creating connection between vng 2 and csr 3, type "nobgp"...
Extracted info for vpngw: ASN 65002, GW0 40.127.161.56, 10.2.0.4. GW1 40.127.161.68, 10.2.0.5.
Configuring tunnels between CSR 3 and VPN GW 2
Configuring tunnel 320 in CSR 52.138.173.126...
No routing protocol configured on 320 in CSR 52.138.173.126...
Configuring tunnel 321 in CSR 52.138.173.126...
No routing protocol configured on 321 in CSR 52.138.173.126...
Creating VPN connections in Azure...
Creating connection between vng 2 and csr 4, type "nobgp"...
Extracted info for vpngw: ASN 65002, GW0 40.127.161.56, 10.2.0.4. GW1 40.127.161.68, 10.2.0.5.
Configuring tunnels between CSR 4 and VPN GW 2
Configuring tunnel 420 in CSR 40.69.71.195...
No routing protocol configured on 420 in CSR 40.69.71.195...
Configuring tunnel 421 in CSR 40.69.71.195...
No routing protocol configured on 421 in CSR 40.69.71.195...
Creating VPN connections in Azure...
Creating connection between csr 3 and csr 4, type "ospf"...
Configuring tunnel 34 in CSR 52.138.173.126...
Configuring OSPF on tunnel 34 in CSR 52.138.173.126...
Configuring tunnel 43 in CSR 40.69.71.195...
Configuring OSPF on tunnel 43 in CSR 40.69.71.195...
Creating connection between csr 3 and csr 5, type "ospf"...
Configuring tunnel 35 in CSR 52.138.173.126...
Configuring OSPF on tunnel 35 in CSR 52.138.173.126...
Configuring tunnel 53 in CSR 52.164.228.44...
Configuring OSPF on tunnel 53 in CSR 52.164.228.44...
Creating connection between csr 4 and csr 5, type "ospf"...
Configuring tunnel 45 in CSR 40.69.71.195...
Configuring OSPF on tunnel 45 in CSR 40.69.71.195...
Configuring tunnel 54 in CSR 52.164.228.44...
Configuring OSPF on tunnel 54 in CSR 52.164.228.44...
Getting BGP neighbors for router 1:vng1:65001...
BGP neighbors for vng1:

Getting BGP neighbors for router 2:vng:65002...
BGP neighbors for vng2:
Neighbor    ASN    State      ConnectedDuration    RoutesReceived    MessagesSent    MessagesReceived
----------  -----  ---------  -------------------  ----------------  --------------  ------------------
10.2.0.4    65002  Connected  00:15:13.9595914     3                 40              39
10.2.0.5    65002  Unknown                         0                 0               0
10.2.0.4    65002  Unknown                         0                 0               0
10.2.0.5    65002  Connected  00:15:14.1940440     3                 37              42
Getting BGP neighbors for router 3:csr:65100...
BGP neighbors for csr3-nva (52.138.173.126):

Getting BGP neighbors for router 4:csr:65100...
BGP neighbors for csr4-nva (40.69.71.195):

Getting BGP neighbors for router 5:csr:65100...
BGP neighbors for csr5-nva (52.164.228.44):

Your resources should be ready to use in resource group wthbgp. Enjoy!
</pre>

</details>
<br>

### Inspecting the Environment

The effective routes in the Vnets only show the local prefixes, plus the /32 prefixes configured for the VPN tunnels:

```
az network nic show-effective-route-table -n testvm1VMNic -g $rg -o table
Source                 State    Address Prefix    Next Hop Type          Next Hop IP
---------------------  -------  ----------------  ---------------------  --------------
Default                Active   10.1.0.0/16       VnetLocal
VirtualNetworkGateway  Active   10.2.0.5/32       VirtualNetworkGateway  40.127.161.185
VirtualNetworkGateway  Active   10.2.0.4/32       VirtualNetworkGateway  40.127.161.185
VirtualNetworkGateway  Active   10.3.0.10/32      VirtualNetworkGateway  40.127.161.185
VirtualNetworkGateway  Active   10.4.0.10/32      VirtualNetworkGateway  40.127.161.185
Default                Active   0.0.0.0/0         Internet
Default                Active   10.0.0.0/8        None
Default                Active   100.64.0.0/10     None
Default                Active   192.168.0.0/16    None
Default                Active   25.33.80.0/20     None
Default                Active   25.41.3.0/25      None
```

By the way, if you look at the effective routes in Vnet2, you will notice a difference in the next hop: with active/passive gateways the next hop is the public IP of the VPN gateway, with active/active the next hops are the private IPs (not that this is too important for this challenge):

```
 az network nic show-effective-route-table -n testvm2VMNic -g $rg -o table
Source                 State    Address Prefix    Next Hop Type          Next Hop IP
---------------------  -------  ----------------  ---------------------  -------------
Default                Active   10.2.0.0/16       VnetLocal
VirtualNetworkGateway  Active   10.1.0.254/32     VirtualNetworkGateway  10.2.0.4
VirtualNetworkGateway  Active   10.1.0.254/32     VirtualNetworkGateway  10.2.0.5
VirtualNetworkGateway  Active   10.3.0.10/32      VirtualNetworkGateway  10.2.0.4
VirtualNetworkGateway  Active   10.3.0.10/32      VirtualNetworkGateway  10.2.0.5
VirtualNetworkGateway  Active   10.4.0.10/32      VirtualNetworkGateway  10.2.0.4
VirtualNetworkGateway  Active   10.4.0.10/32      VirtualNetworkGateway  10.2.0.5
Default                Active   0.0.0.0/0         Internet
Default                Active   10.0.0.0/8        None
Default                Active   100.64.0.0/10     None
Default                Active   192.168.0.0/16    None
Default                Active   25.33.80.0/20     None
Default                Active   25.41.3.0/25      None
```

Two Virtual Network Gateways have been deployed:

```
az network vnet-gateway list -o table -g $rg
ActiveActive    EnableBgp    EnablePrivateIpAddress    GatewayType    Location     Name    ProvisioningState    ResourceGroup    ResourceGuid                          VpnGatewayGeneration    VpnType
--------------  -----------  ------------------------  -------------  -----------  ------  -------------------  ---------------  ------------------------------------  ----------------------  ----------
False           True         False                     Vpn            northeurope  vng1    Succeeded            bgp1             375141c0-afb1-4cfc-81c4-41b32a7cd9a2  Generation1             RouteBased
True            True         False                     Vpn            northeurope  vng2    Succeeded            bgp1             971fd1bc-27ef-4357-a35f-99c86642763b  Generation1             RouteBased
```

Note that the deployment script enables BGP in the gateway resources, but not in the VPN connections:

```
az network vpn-connection list -g $rg -o table
ConnectionProtocol    ConnectionType    DpdTimeoutSeconds    EgressBytesTransferred    EnableBgp    ExpressRouteGatewayBypass    IngressBytesTransferred    Location     Name         ProvisioningState    ResourceGroup    ResourceGuid                          RoutingWeight    UseLocalAzureIpAddress    UsePolicyBasedTrafficSelectors
--------------------  ----------------  -------------------  ------------------------  -----------  ---------------------------  -------------------------  -----------  -----------  -------------------  ---------------  ------------------------------------  ---------------  ------------------------  --------------------------------
IKEv2                 IPsec             0                    0                         False        False                        0                          northeurope  vng1tocsr3   Succeeded            bgp1             625db16e-96f5-4d1a-b063-944811f007fe  10               False                     False
IKEv2                 IPsec             0                    0                         False        False                        0                          northeurope  vng1tocsr4   Succeeded            bgp1             37ce8935-f34b-4eec-9959-96444f24b009  10               False                     False
IKEv2                 IPsec             0                    0                         False        False                        0                          northeurope  vng1tovng2a  Succeeded            bgp1             8325e684-c79c-486c-b8b4-3aff53c150dd  10               False                     False
IKEv2                 IPsec             0                    0                         False        False                        0                          northeurope  vng1tovng2b  Succeeded            bgp1             bb9452f7-96f6-43bc-bfc2-e50a83776455  10               False                     False
IKEv2                 IPsec             0                    0                         False        False                        0                          northeurope  vng2tocsr3   Succeeded            bgp1             372a0138-bdf0-47da-9ef1-5aa608227710  10               False                     False
IKEv2                 IPsec             0                    0                         False        False                        0                          northeurope  vng2tocsr4   Succeeded            bgp1             5cbdb91e-cfcd-4c87-a224-33e48724be34  10               False                     False
IKEv2                 IPsec             0                    0                         False        False                        0                          northeurope  vng2tovng1a  Succeeded            bgp1             563f9ac4-6209-4c8f-9ef7-0d5082f8e8bc  10               False                     False
```

The onprem routers know some routes, but not the Vnet prefixes. For example, CSR3 knows about CSR4 and about CSR5 (the onprem prefix 10.5.0.0/16) because the script connected CSR4 and CSR5 via iBGP, but not about Vnets 1 and 2:

```
❯ csr4=$(az network public-ip show -n csr4-pip -g $rg --query ipAddress -o tsv)
❯ ssh $csr4 "sh ip route"
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2, m - OMP
       n - NAT, Ni - NAT inside, No - NAT outside, Nd - NAT DIA
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       H - NHRP, G - NHRP registered, g - NHRP registration summary
       o - ODR, P - periodic downloaded static route, l - LISP
       a - application route
       + - replicated route, % - next hop override, p - overrides from PfR

Gateway of last resort is 10.4.0.1 to network 0.0.0.0

S*    0.0.0.0/0 [254/0] via 10.4.0.1
      10.0.0.0/8 is variably subnetted, 9 subnets, 3 masks
S        10.1.0.254/32 is directly connected, Tunnel410
S        10.2.0.4/32 is directly connected, Tunnel420
S        10.2.0.5/32 is directly connected, Tunnel421
S        10.3.0.10/32 is directly connected, Tunnel43
S        10.4.0.0/16 [1/0] via 10.4.0.1
C        10.4.0.0/24 is directly connected, GigabitEthernet1
L        10.4.0.10/32 is directly connected, GigabitEthernet1
B        10.5.0.0/16 [200/0] via 10.5.0.10, 21:06:14
S        10.5.0.10/32 is directly connected, Tunnel45
      13.0.0.0/32 is subnetted, 3 subnets
S        13.69.215.204 [1/0] via 10.4.0.1
S        13.70.194.156 [1/0] via 10.4.0.1
S        13.79.225.230 [1/0] via 10.4.0.1
      40.0.0.0/32 is subnetted, 2 subnets
S        40.85.112.200 [1/0] via 10.4.0.1
S        40.85.126.53 [1/0] via 10.4.0.1
      109.0.0.0/32 is subnetted, 1 subnets
S        109.125.122.99 [1/0] via 10.4.0.1
      168.63.0.0/32 is subnetted, 1 subnets
S        168.63.129.16 [254/0] via 10.4.0.1
      169.254.0.0/32 is subnetted, 1 subnets
S        169.254.169.254 [254/0] via 10.4.0.1
```

You can verify connectivity between the VMs in the branches and the core MPLS network. In this example, we are testing connectivity between the vnets of CSR3 and CSR5:

```
❯ testvm3=$(az network public-ip show -n testvm3-pip -g $rg --query ipAddress -o tsv)
❯ ssh -n -o BatchMode=yes -o StrictHostKeyChecking=no "$testvm3" "ping 10.5.1.4 -c 5"
10.5.1.4 (10.5.1.4) 56(84) bytes of data.
64 bytes from 10.5.1.4: icmp_seq=1 ttl=62 time=15.7 ms
64 bytes from 10.5.1.4: icmp_seq=2 ttl=62 time=9.87 ms
64 bytes from 10.5.1.4: icmp_seq=3 ttl=62 time=10.0 ms
64 bytes from 10.5.1.4: icmp_seq=4 ttl=62 time=9.90 ms
64 bytes from 10.5.1.4: icmp_seq=5 ttl=62 time=11.8 ms

--- 10.5.1.4 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4004ms
rtt min/avg/max/mdev = 9.879/11.494/15.776/2.271 ms
```
